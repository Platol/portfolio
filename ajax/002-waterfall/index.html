<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>瀑布流-waterfall</title>
    <script src="../js/ajax.js"></script>
    <!--[if lt IE 8]>
	<script src="../js/json2.js"></script>
<![endif]-->
    <style>
        body {
            margin: 0;
            background: #f5f5f5;
        }

        ul {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        p {
            margin: 0;
            padding: 0;
        }

        #waterfall {
            width: 1048px;
            margin: 0 auto;
        }

        #waterfall:after {
            content: "";
            display: block;
            clear: both;
        }

        #waterfall li {
            float: left;
            margin: 0 10px;
        }

        #waterfall div {
            width: 220px;
            padding: 10px;
            border: 1px solid #ddd;
            margin-top: 20px;
            background: #fff;
            border-radius: 5px;
        }

        #waterfall img {
            width: 220px;
        }

        #waterfall p {
            padding-top: 10px;
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
    </style>
</head>

<body>
    <ul id="waterfall">
        <li></li>
        <li></li>
        <li></li>
        <li></li>
    </ul>

    <script>
        (function () {
            var waterfall = document.getElementById('waterfall');
            var lis = waterfall.getElementsByTagName('li');
            var len = lis.length;
            var page = 1;
            var b = true;

            getList();

            window.onscroll = function () {
                var _index = getShort();
                var li = lis[_index];
                var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;

                if (getTop(li) + li.offsetHeight < document.documentElement.clientHeight + scrollTop) {
                    if (b) {
                        b = false;
                        page++;
                        getList();
                    }
                }
            }

            function getList() {
                /** 
                 * 接口：'https://api.apiopen.top/getImages'
                 * 参数（可选）：page、count
                 * 返回示例：
                 * {
                        "code": 200,
                        "message": "成功!",
                        "result": [
                            {
                                "id": 596,
                                "time": "2018-09-18 17:52:43",
                                "img": "http://ww4.sinaimg.cn/large/7a8aed7bgw1eurhwfc5z7j20hs0qomzz.jpg"
                            },
                            {
                                "id": 597,
                                "time": "2018-09-18 17:52:43",
                                "img": "http://ww3.sinaimg.cn/large/7a8aed7bgw1eup75gxp8qj20hr0qoae8.jpg"
                            },
                            {
                                "id": 598,
                                "time": "2018-09-18 17:52:43",
                                "img": "http://ww2.sinaimg.cn/large/7a8aed7bgw1eukj6vosygj20gs0p0act.jpg"
                            },
                            ...
                        ]
                    }
                */
                
                ajax('get', 'https://api.apiopen.top/getImages', 'page=' + page, function (data) {
                    var data = JSON.parse(data);

                    if (!data.result.length) {
                        return;
                    }

                    for (var i = 0; i < data.result.length; i++) {
                        var _index = getShort();
                        var div = document.createElement('div');
                        var img = document.createElement('img');
                        var p = document.createElement('p');

                        img.src = data.result[i].img;
                        img.style.width = '220px';
                        img.style.height = data.result[i].height * (220 / data.result[i].width) + 'px';
                        div.appendChild(img);
                        p.innerHTML = data.result[i].title;
                        div.appendChild(p);

                        lis[_index].appendChild(div);
                    }

                    b = true;

                });
            }

            function getShort() {
                var index = 0;
                var iH = lis[index].offsetHeight;

                for (var i = 1; i < len; i++) {
                    if (lis[i].offsetHeight < iH) {
                        index = i;
                        iH = lis[i].offsetHeight;
                    }
                }

                return index;
            }

            function getTop(elem) {
                var top = 0;

                while (elem) {
                    top += elem.offsetTop;
                    elem = elem.offsetParent;
                }

                return top;
            }
        })();
    </script>
</body>

</html>